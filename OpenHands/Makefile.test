# Testing and QA Makefile
# Run tests, linting, type checking, and benchmarks

.PHONY: help test test-unit test-integration test-e2e test-all
.PHONY: lint format typecheck qa coverage
.PHONY: benchmark validate-swe-bench validate-webarena
.PHONY: clean

help:
	@echo "OpenHands Testing & QA Commands"
	@echo "================================"
	@echo ""
	@echo "Testing:"
	@echo "  make test              - Run unit tests only"
	@echo "  make test-unit         - Run unit tests"
	@echo "  make test-integration  - Run integration tests"
	@echo "  make test-e2e          - Run end-to-end tests (requires API key)"
	@echo "  make test-all          - Run all tests"
	@echo ""
	@echo "Quality Assurance:"
	@echo "  make lint              - Run linting checks"
	@echo "  make format            - Format code"
	@echo "  make typecheck         - Run type checking"
	@echo "  make qa                - Run all QA checks"
	@echo "  make coverage          - Generate coverage report"
	@echo ""
	@echo "Benchmarking:"
	@echo "  make benchmark         - Run performance benchmarks"
	@echo "  make validate-swe-bench    - Run SWE-bench validation"
	@echo "  make validate-webarena     - Run WebArena validation"
	@echo ""
	@echo "Utilities:"
	@echo "  make clean             - Clean test artifacts"

# ============================================================================
# Testing
# ============================================================================

test: test-unit

test-unit:
	@echo "Running unit tests..."
	pytest tests/unit -v -m unit

test-integration:
	@echo "Running integration tests..."
	pytest tests/integration -v -m integration

test-e2e:
	@echo "Running end-to-end tests (requires API key)..."
	pytest tests/e2e -v -m e2e

test-all:
	@echo "Running all tests..."
	pytest tests/ -v

test-fast:
	@echo "Running fast tests only (excluding slow tests)..."
	pytest tests/ -v -m "not slow"

# ============================================================================
# Quality Assurance
# ============================================================================

lint:
	@echo "Running linting checks..."
	ruff check openhands/ tests/

format:
	@echo "Formatting code..."
	ruff format openhands/ tests/
	ruff check --fix openhands/ tests/

typecheck:
	@echo "Running type checking..."
	mypy openhands/

qa: lint typecheck
	@echo "All QA checks passed!"

coverage:
	@echo "Generating coverage report..."
	pytest tests/unit tests/integration --cov=openhands --cov-report=html --cov-report=term
	@echo "Coverage report generated in htmlcov/index.html"

# ============================================================================
# Benchmarking
# ============================================================================

benchmark:
	@echo "Running performance benchmarks..."
	python benchmarks/performance_compare.py --task all --runs 3 --output benchmark_results.json

benchmark-quick:
	@echo "Running quick benchmark..."
	python benchmarks/performance_compare.py --task simple --runs 1

monitor:
	@echo "Running resource monitor..."
	python benchmarks/resource_monitor.py --duration 30 --output monitor_results.json

cost-estimate:
	@echo "Cost estimation example..."
	python benchmarks/cost_analyzer.py --estimate --input-tokens 10000 --output-tokens 5000

# ============================================================================
# Validation
# ============================================================================

validate-swe-bench:
	@echo "Running SWE-bench validation..."
	python validation/validate_swe_bench.py --dataset small --output swe_bench_results.json

validate-webarena:
	@echo "Running WebArena validation..."
	python validation/validate_webarena.py --tasks all --output webarena_results.json

# ============================================================================
# Utilities
# ============================================================================

clean:
	@echo "Cleaning test artifacts..."
	rm -rf .pytest_cache
	rm -rf .mypy_cache
	rm -rf .ruff_cache
	rm -rf htmlcov
	rm -rf .coverage
	rm -rf coverage.xml
	rm -rf *.egg-info
	rm -rf dist
	rm -rf build
	find . -type d -name __pycache__ -exec rm -rf {} + 2>/dev/null || true
	find . -type f -name "*.pyc" -delete
	@echo "Cleanup complete!"

install-dev:
	@echo "Installing development dependencies..."
	pip install pytest pytest-asyncio pytest-cov
	pip install ruff mypy
	pip install psutil

# ============================================================================
# CI/CD
# ============================================================================

ci: qa test-fast
	@echo "CI checks passed!"

ci-full: qa test-all coverage
	@echo "Full CI checks passed!"
