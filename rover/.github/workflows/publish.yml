name: Publish
run-name: (${{ github.event.inputs.project }}) Publish ${{ github.event.inputs.tag_name }}

concurrency: production

on:
  workflow_dispatch:
    inputs:
      project:
        description: 'Select the project to release'
        required: true
        type: choice
        default: cli
        options:
          - cli
          - extension
      version:
        description: 'The project version to release'
        required: true
      dryRun:
        description: 'Dry-run job to avoid publishing to NPM or the extension marketplaces'
        required: true
        type: boolean
        default: false

env:
  TAG_NAME: ${{ inputs.project }}/v${{ inputs.version }}

jobs:
  publish:
    timeout-minutes: 15
    environment: production
    runs-on: ubuntu-latest

    steps:
      - name: Echo inputs
        run: |
          echo "Project: $PROJECT"
          echo "Version: $VERSION"
          echo "Tag name: $TAG_NAME"
          echo "Dry Run: $DRY_RUN"
        env:
          PROJECT: ${{ inputs.project }}
          VERSION: ${{ inputs.version }}
          DRY_RUN: ${{ inputs.dryRun }}

      - name: Clone
        uses: actions/checkout@v4

      - name: Setup Node.js 22
        uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Check if release exists
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "Checking if release exists for tag: ${{ env.TAG_NAME }}"
          if ! gh release view "${{ env.TAG_NAME }}" --repo ${{ github.repository }}; then
            echo "Error: Release with tag '${{ env.TAG_NAME }}' does not exist!"
            echo "Please run the Release workflow first to create the release."
            exit 1
          fi
          echo "âœ“ Release found for tag: ${{ env.TAG_NAME }}"

      - name: Download Release Asset (CLI)
        if: inputs.project == 'cli'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "Downloading CLI release asset (.tgz) from tag: ${{ env.TAG_NAME }}"
          MAX_RETRIES=3
          RETRY_COUNT=0
          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            if gh release download "${{ env.TAG_NAME }}" \
              --repo ${{ github.repository }} \
              --pattern "*.tgz" \
              --dir ./; then
              echo "âœ“ Download successful"
              break
            else
              RETRY_COUNT=$((RETRY_COUNT + 1))
              if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
                echo "âš ï¸ Download failed. Retrying in 5 seconds... (Attempt $((RETRY_COUNT + 1))/$MAX_RETRIES)"
                sleep 5
              else
                echo "âŒ Download failed after $MAX_RETRIES attempts"
                exit 1
              fi
            fi
          done
          ASSET_NAME=$(ls *.tgz | head -1)
          echo "Downloaded: $ASSET_NAME"
          echo "ASSET_NAME=$ASSET_NAME" >> $GITHUB_ENV

      - name: Download Release Asset (Extension)
        if: inputs.project == 'extension'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "Downloading Extension release asset (.vsix) from tag: ${{ env.TAG_NAME }}"
          MAX_RETRIES=3
          RETRY_COUNT=0
          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            if gh release download "${{ env.TAG_NAME }}" \
              --repo ${{ github.repository }} \
              --pattern "*.vsix" \
              --dir ./; then
              echo "âœ“ Download successful"
              break
            else
              RETRY_COUNT=$((RETRY_COUNT + 1))
              if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
                echo "âš ï¸ Download failed. Retrying in 5 seconds... (Attempt $((RETRY_COUNT + 1))/$MAX_RETRIES)"
                sleep 5
              else
                echo "âŒ Download failed after $MAX_RETRIES attempts"
                exit 1
              fi
            fi
          done
          ASSET_NAME=$(ls *.vsix | head -1)
          echo "Downloaded: $ASSET_NAME"
          echo "ASSET_NAME=$ASSET_NAME" >> $GITHUB_ENV

      - name: Publish NPM (CLI)
        if: inputs.project == 'cli' && inputs.dryRun == false
        run: |
          echo "//registry.npmjs.org/:_authToken=${{ secrets.NPM_TOKEN }}" > ~/.npmrc
          npm publish ${{ env.ASSET_NAME }} --access public
          echo "âœ“ Successfully published to NPM"

      - name: (Dry Run) Publish NPM (CLI)
        if: inputs.project == 'cli' && inputs.dryRun == true
        run: echo "Skipping publish phase."

      - name: Publish VSCode Marketplace (Extension)
        if: inputs.project == 'extension'
        run: |
          npx @vscode/vsce publish --pat ${{ secrets.VSCODE_MARKETPLACE_TOKEN }} --packagePath ${{ github.workspace }}/${{ env.ASSET_NAME }}
          echo "âœ“ Successfully published to VSCode Marketplace"

      - name: (Dry Run) Publish VSCode Marketplace (Extension)
        if: inputs.project == 'extension' && inputs.dryRun == true
        run: echo "Skipping publish phase"

      - name: Notify Google Chat on Success
        if: success() && inputs.dryRun == false
        env:
          WEBHOOK_URL: ${{ secrets.GOOGLE_CHAT_WEBHOOK }}
          PROJECT: ${{ inputs.project }}
          VERSION: ${{ inputs.version }}
          TAG_NAME: ${{ env.TAG_NAME }}
        run: |
          if [ "${{ inputs.project }}" == "cli" ]; then
            REGISTRY="NPM"
            REGISTRY_URL="https://www.npmjs.com/package/@endorhq/rover"
          else
            REGISTRY="VSCode Marketplace"
            REGISTRY_URL="https://marketplace.visualstudio.com/items?itemName=endorhq.rover"
          fi

          curl -X POST "$WEBHOOK_URL" \
            -H "Content-Type: application/json" \
            -d @- <<EOF
          {
            "text": "ðŸ“¦ *Package Published Successfully*\n\n*Project:* ${PROJECT}\n*Version:* v${VERSION}\n*Tag:* ${TAG_NAME}\n*Registry:* ${REGISTRY}\n*Registry URL:* ${REGISTRY_URL}\n*Repository:* ${{ github.repository }}\n*Published by:* ${{ github.actor }}"
          }
          EOF

      - name: Notify Google Chat on Failure
        if: failure() && inputs.dryRun == false
        env:
          WEBHOOK_URL: ${{ secrets.GOOGLE_CHAT_WEBHOOK }}
          PROJECT: ${{ inputs.project }}
          VERSION: ${{ inputs.version }}
          WORKFLOW_URL: 'https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}'
        run: |
          curl -X POST "$WEBHOOK_URL" \
            -H "Content-Type: application/json" \
            -d @- <<EOF
          {
            "text": "âŒ *Package Publish Failed*\n\n*Project:* ${PROJECT}\n*Version:* v${VERSION}\n*Repository:* ${{ github.repository }}\n*Failed by:* ${{ github.actor }}\n*Workflow Run:* ${WORKFLOW_URL}\n\nPlease check the workflow logs for details."
          }
          EOF
